<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rscripts pp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c2f33;
            color: white;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
        }

        select, input {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px; /* Squircle effect */
            width: calc(100% - 22px); /* Full width minus padding */
        }

        button {
            background-color: #7289da;
            border: none;
            color: white;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            border-radius: 5px; /* Squircle effect */
        }

        button:hover {
            background-color: #5b6eae;
        }

        #scripts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .script-item {
            background-color: #40444b; /* Background for script items */
            padding: 10px;
            border-radius: 5px; /* Squircle effect */
        }

        textarea {
            width: 100%;
            height: 60px; /* Height for comment box */
            border-radius: 5px; /* Squircle effect */
            border: none; /* Remove default border */
        }

        .no-more {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>BloxSearch</h1>

    <input type="text" id="searchBox" placeholder="Search scripts..." />
    <button onclick="searchScripts()">Search</button>
    
    <div id="scripts-container"></div>

    <!-- Show More Button -->
    <button id="showMoreButton" onclick="showMoreScripts()" style="display:none;">Show More</button>
    
    <div id="noMoreMessage" class="no-more" style="display:none;">Nothing else to see üßê</div>

    <script>
        let allScripts = []; // Store all fetched scripts for searching
        let displayedScripts = []; // Store currently displayed scripts
        let currentIndex = 0; // Track the current index for showing more scripts
        const scriptsToShow = 4; // Number of scripts to show each time

        async function fetchAllScripts() {
            let currentPage = 1;
            let maxPages = 1; // Start with 1 to enter the loop

            while (currentPage <= maxPages) {
                const response = await fetch(`https://rscripts.net/api/v2/scripts?page=${currentPage}&orderBy=date&sort=desc`);
                
                if (response.ok) {
                    const data = await response.json();
                    allScripts = allScripts.concat(data.scripts); // Append new scripts to the array
                    maxPages = data.info.maxPages; // Update maxPages from the response
                    console.log(`Fetched page ${currentPage}:`, data.scripts.length);
                    currentPage++; // Move to the next page
                } else {
                    console.error("Error fetching scripts:", response.statusText);
                    break; // Exit on error
                }
            }

            console.log("Total scripts fetched:", allScripts.length);
            
            // Display the initial set of scripts after fetching all
            displayScripts();
        }

        function displayScripts() {
            const scriptsContainer = document.getElementById('scripts-container');
            
            // Clear previous displayed items before showing new ones
            while (currentIndex < allScripts.length && currentIndex < displayedScripts.length + scriptsToShow) {
                const scriptItem = document.createElement('div');
                scriptItem.classList.add('script-item');
                
                const script = allScripts[currentIndex];
                
                scriptItem.innerHTML = `
                    <h2>${script.title}</h2>
                    <p>${script.description}</p>
                    <img style="width: 40px; height: 40px; border-radius: 50%;" src="${script.user?.image || 'https://i.pravatar.cc/300'}" alt="Profile picture of ${script.user?.username || script.creator}">
                    <p>Creator: ${script.user?.username || script.creator}</p>
                    <img src="${script.image}" alt="${script.title}">
                    <textarea id="script-${script._id}" placeholder="Script content will appear here..."></textarea>
                `;

                const downloadUrl = script.rawScript;

                // Fetch and display the script content
                fetch(downloadUrl)
                    .then((response) => response.text())
                    .then((scriptContent) => {
                        const textArea = scriptItem.querySelector(`#script-${script._id}`);
                        textArea.value = scriptContent;
                    })
                    .catch((error) => {
                        console.error(`Error fetching script content for ${script.title}:`, error);
                    });

                scriptsContainer.appendChild(scriptItem);
                currentIndex++;
                displayedScripts.push(script); // Keep track of displayed scripts
            }
            
            updateShowMoreButton(); // Update Show More button visibility
            
            if (currentIndex >= allScripts.length) { 
                document.getElementById('noMoreMessage').style.display = 'block'; // Show message if no more scripts
                document.getElementById('showMoreButton').style.display = 'none'; // Hide Show More button if no more scripts
            }
        }

        function updateShowMoreButton() {
            if (currentIndex < allScripts.length) { 
                document.getElementById('showMoreButton').style.display = 'block'; 
            } else { 
                document.getElementById('showMoreButton').style.display = 'none'; 
                document.getElementById('noMoreMessage').style.display = 'block'; 
            }
        }

        function searchScripts() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            
            // Filter the stored scripts based on the search query
           displayedScripts = allScripts.filter(script => 
               script.title.toLowerCase().includes(query) || 
               script.description.toLowerCase().includes(query)
           );

           currentIndex = 0; // Reset index for new search results

           const scriptsContainer = document.getElementById('scripts-container');
           scriptsContainer.innerHTML = ''; // Clear previous displayed items

           displayScripts(); // Display filtered results after search
           updateShowMoreButton(); // Update Show More button visibility after search

           if (displayedScripts.length === 0) { 
               document.getElementById('noMoreMessage').style.display = 'block'; 
               document.getElementById('showMoreButton').style.display = 'none'; 
           } else { 
               document.getElementById('noMoreMessage').style.display = 'none'; 
           }
       }

       function showMoreScripts() {
           displayScripts(); // Load more scripts when clicked
       }

       // Fetch all scripts when the page loads
       window.onload = fetchAllScripts;

   </script>
</body>
</html>
